#!/bin/sh
# Copyright 2013 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -e

DIR="$( cd "$( dirname "$0" )" && pwd )"
if [ $(uname -s) = 'Darwin' ]; then
  TARGET_DIR=~/Library/Application Support/Google/Chrome/NativeMessagingHosts
  FF_TARGET_DIR=~/.mozilla/native-messaging-hosts
else
  TARGET_DIR=~/.config/google-chrome/NativeMessagingHosts
  FF_TARGET_DIR=~/.mozilla/native-messaging-hosts
fi

HOST_NAME=@JSON_CHR@
FF_HOST_NAME=@JSON_FF@
BINDIR=~/bin/@ADN_NAME@/@ADDNVER@
FILE=@Addn_Chrome@@MySuffix1@@MySuffix2@
LIBFILE=lib@Addn_Native@@MySuffix1@@MySuffix2@_@Addn_VERSION@.so
# Create directory to store native messaging host.
mkdir -p $TARGET_DIR
mkdir -p $FF_TARGET_DIR
mkdir -p $BINDIR

# Copy native messaging host manifest.
cp $DIR/$HOST_NAME $TARGET_DIR
cp $DIR/$FF_HOST_NAME $FF_TARGET_DIR/$HOST_NAME
cp $DIR/$FILE $BINDIR
cp $DIR/$LIBFILE $BINDIR

# Update host path in the manifest.
HOST_PATH=$BINDIR/$FILE
sed -i -e "s|HOST_PATH|$HOST_PATH|g" $TARGET_DIR/$HOST_NAME
sed -i -e "s|HOST_PATH|$HOST_PATH|g" $FF_TARGET_DIR/$HOST_NAME

# Set permissions for the manifest so that all users can read it.
chmod o+r $TARGET_DIR/$HOST_NAME
chmod o+r $FF_TARGET_DIR/$HOST_NAME

echo Native messaging host $HOST_NAME has been installed.
